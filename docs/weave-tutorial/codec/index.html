<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Codec · IOV Documentations</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&gt; [PR#1](https://github.com/iov-one/tutorial/pull/1): _Create order book models_"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Codec · IOV Documentations"/><meta property="og:type" content="website"/><meta property="og:url" content="http://docs.iov.one/"/><meta property="og:description" content="&gt; [PR#1](https://github.com/iov-one/tutorial/pull/1): _Create order book models_"/><meta property="og:image" content="http://docs.iov.one/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="http://docs.iov.one/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="IOV Documentations"/></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://github.com/iov-one" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Weave Tutorial</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Introduction<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/intro">Welcome to IOV!</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">IOV Name Service<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Validator</h4><ul><li class="navListItem"><a class="navItem" href="/docs/iov-name-service/validator/rewards">Rewards</a></li><li class="navListItem"><a class="navItem" href="/docs/iov-name-service/validator/setup">Setup</a></li><li class="navListItem"><a class="navItem" href="/docs/iov-name-service/validator/troubleshooter">Troubleshooter</a></li><li class="navListItem"><a class="navItem" href="/docs/iov-name-service/validator/faq">FAQ</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Clients</h4><ul><li class="navListItem"><a class="navItem" href="/docs/iov-name-service/clients/iov-core">IOV-core</a></li><li class="navListItem"><a class="navItem" href="/docs/iov-name-service/clients/rest-api">REST API</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Weave Overview<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/weave/welcome">Welcome</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Basics</h4><ul><li class="navListItem"><a class="navItem" href="/docs/weave/basics/blockchain">Blockchain</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/basics/consensus">Consensus</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/basics/authentication">Authentication</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/basics/state">State Machine</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Design</h4><ul><li class="navListItem"><a class="navItem" href="/docs/weave/design/overview">Guiding Design Principles</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/design/extension">Extension</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/design/transaction-flow">Flow of Transactions</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/design/permissions">Permissions</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/design/queries">Queries</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Configuration</h4><ul><li class="navListItem"><a class="navItem" href="/docs/weave/configuration/application">Application</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/configuration/tendermint">Tendermint</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/configuration/validators">Validators</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">API specifications</h4><ul><li class="navListItem"><a class="navItem" href="/docs/weave/weave-api-spec/address-derivation">Address Derivation</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/weave-api-spec/weave-transaction-spec">Weave Transactions</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/weave-api-spec/tx-sign-spec">Transaction Signatures</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/weave-api-spec/weave-query-spec">Querying Weave</a></li><li class="navListItem"><a class="navItem" href="/docs/weave/weave-api-spec/modules">Modules</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Weave Tutorial<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/weave-tutorial/overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/weave-tutorial/domain">Domain</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/weave-tutorial/codec">Codec</a></li><li class="navListItem"><a class="navItem" href="/docs/weave-tutorial/models">Models</a></li><li class="navListItem"><a class="navItem" href="/docs/weave-tutorial/messages">Messages</a></li><li class="navListItem"><a class="navItem" href="/docs/weave-tutorial/buckets">Buckets</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Codec</h1></header><article><div><span><blockquote>
<p><a href="https://github.com/iov-one/tutorial/pull/1">PR#1</a>: <em>Create order book models</em></p>
</blockquote>
<p>Weave defines <code>Marshaller</code> and <code>Persistent</code> interface standards. These interfaces are automatically implemented by any code autogenerated by protoc from protobuf files, and we recommend using .proto files to specify the serialization format for any persistent data in our application (internal state as well as transactions and messages). However, if you have never worked with protobuf, this might be a bit of a challenge, so we explain a workflow that we use in weave based projects.</p>
<h2><a class="anchor" aria-hidden="true" id="create-codec-file"></a><a href="#create-codec-file" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create Codec file</h2>
<p>First imagine the shape of your classes. The product of your imagination will be called <code>Codec</code>. And the language of expressing shape of the classes is: <a href="https://developers.google.com/protocol-buffers/docs/proto3">proto3</a>. There are several different <code>int encodings</code>, <code>byte slices</code>, <code>strings</code>, and nested structures. And fields may be repeated. So forget complex types with methods now and just focus on the actual data structure.</p>
<p>Codec is the first component that needs to be designed. Keep in mind that this part is the most important since the whole module will depend on <em>codec</em>. Codec resembles  <em>model</em> in mvc pattern. Yet codec not only defines the model representation but marshalling/unmarshalling and interactions with messages. Codec defines the whole application state models and more. On this article, we would not go as far as explaining every proto message. One example for each message and state would be enough. Furthermore, if you want to see all the implementation, you can check out <a href="https://github.com/iov-one/tutorial/blob/master/x/orderbook/codec.proto">tutorial</a></p>
<h2><a class="anchor" aria-hidden="true" id="state"></a><a href="#state" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>State</h2>
<p>In the previous section, we explained how to define your domain thus attributes if models. Here <code>Trade</code> is defined as proto message. The <a href="https://github.com/iov-one/tutorial/blob/master/x/orderbook/codec.proto#L75-L88">x/codec.proto</a> file defines the <code>Trade</code> type rather simply, once you remove the comments, this is all that is left:</p>
<pre><code class="hljs css language-protobuf"><span class="hljs-comment">// Trade is a settled partial/full order</span>
<span class="hljs-comment">// We store these as independent entities to help with queries to map</span>
<span class="hljs-comment">// the prices over time. They are also referenced by the Orders, so we can</span>
<span class="hljs-comment">// see how much was fulfilled.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Ask and Bid tickers are "inherited" from the orderbook</span>
<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">Trade</span> </span>{
  weave.Metadata metadata = <span class="hljs-number">1</span>;
  <span class="hljs-built_in">bytes</span> id = <span class="hljs-number">2</span> [(gogoproto.customname) = <span class="hljs-string">"ID"</span>];
  <span class="hljs-built_in">bytes</span> order_book_id = <span class="hljs-number">3</span> [(gogoproto.customname) = <span class="hljs-string">"OrderBookID"</span>];
  <span class="hljs-built_in">bytes</span> order_id = <span class="hljs-number">4</span> [(gogoproto.customname) = <span class="hljs-string">"OrderID"</span>];
  <span class="hljs-comment">// Address of taker (this is an order that was instantly fulfilled)</span>
  <span class="hljs-built_in">bytes</span> taker = <span class="hljs-number">5</span> [(gogoproto.casttype) = <span class="hljs-string">"github.com/iov-one/weave.Address"</span>];
  <span class="hljs-comment">// Address of maker (this is an order that was stored first before fulfillment)</span>
  <span class="hljs-built_in">bytes</span> maker = <span class="hljs-number">6</span> [(gogoproto.casttype) = <span class="hljs-string">"github.com/iov-one/weave.Address"</span>];
  <span class="hljs-comment">// this is how much each side paid (they got the opposite one)</span>
  coin.Coin maker_paid = <span class="hljs-number">7</span>;
  coin.Coin taker_paid = <span class="hljs-number">8</span>;
  <span class="hljs-comment">// executed_at defines execution time of an order</span>
  <span class="hljs-built_in">int64</span> executed_at = <span class="hljs-number">9</span> [(gogoproto.casttype) = <span class="hljs-string">"github.com/iov-one/weave.UnixTime"</span>];
}
</code></pre>
<p>As you can see above, weave is heavily using <code>bytes</code> for identities, addresses, etc. At first glance, this might seem difficult to handle but if you take a look at <a href="https://github.com/iov-one/tutorial/blob/master/x/orderbook/bucket.go#L125">x/orderbook/bucket</a> you can see it is useful for indexing and performance</p>
<p>Note that the package defined in the protobuf file must match the package name used by the Go language code in the same directory.</p>
<p>You can also import types from one proto file into another. Make sure to use the full github path so that the generated go code has properly set imports. The package name above is also used as a namespace for the imported protobuf definitions. This is how <a href="https://github.com/iov-one/weave/blob/master/x/cash/codec.proto">x/cash</a> creates a wallet that contains an array of tokens of different currencies.
2 critical points needs to be explained in state models and messages.</p>
<p>Firstly, You must have noticed:</p>
<pre><code class="hljs css language-protobuf">weave.Metadata metadata = <span class="hljs-number">1</span>;
</code></pre>
<p><code>weave.Metadata</code> enables upgrading the code on chain without downtime. It is required if you want to use any <a href="https://github.com/iov-one/weave/tree/master/x">weave provided extensions</a>. <a href="https://github.com/iov-one/weave/tree/v0.20.0/migration">Migrations</a> package will be explained in more detail in further sections.</p>
<p>The second one is how the magic <code>ID</code> field works. This will be explained in <a href="/docs/weave-tutorial/models">Models</a> section.</p>
<h2><a class="anchor" aria-hidden="true" id="message-definitions"></a><a href="#message-definitions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Message Definitions</h2>
<pre><code class="hljs css language-protobuf"><span class="hljs-comment">// CreateOrderMsg will offer to sell some currency on an orderbook</span>
<span class="hljs-comment">// at a given price.</span>
<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">CreateOrderMsg</span> </span>{
  weave.Metadata metadata = <span class="hljs-number">1</span>;
  <span class="hljs-comment">// Trader is the Address that will pay the offer, and get the matches.</span>
  <span class="hljs-comment">// Defaults to x.MainSigner() if left blank</span>
  <span class="hljs-built_in">bytes</span> trader = <span class="hljs-number">2</span> [(gogoproto.casttype) = <span class="hljs-string">"github.com/iov-one/weave.Address"</span>];
  <span class="hljs-comment">// OrderBookID must support Offer.Ticker as one of the two sides,</span>
  <span class="hljs-comment">// Which side this order will be, is automatically inferred</span>
  <span class="hljs-built_in">bytes</span> order_book_id = <span class="hljs-number">3</span> [(gogoproto.customname) = <span class="hljs-string">"OrderBookID"</span>];
  <span class="hljs-comment">// Offer is how much will be paid</span>
  coin.Coin offer = <span class="hljs-number">4</span>;
  <span class="hljs-comment">// Price is how much is requested for each unit of the offer token</span>
  Amount price = <span class="hljs-number">5</span>;
}
</code></pre>
<p>Noticed <code>(gogoproto.casttype)</code> and <code>(gogoproto.customname)</code>?</p>
<pre><code class="hljs css language-protobuf"><span class="hljs-built_in">bytes</span> trader = <span class="hljs-number">2</span> [(gogoproto.casttype) = <span class="hljs-string">"github.com/iov-one/weave.Address"</span>];
</code></pre>
<p><code>(gogoproto.casttype)</code> indicates this field will be cast to <code>weave.Address</code>. Compiled codec.pb.go field:</p>
<pre><code class="hljs css language-go"><span class="hljs-comment">// Address of trader that created order (ad gets paid from it)</span>
    Trader      github_com_iov_one_weave.Address <span class="hljs-string">`protobuf:"bytes,3,opt,name=trader,proto3,casttype=github.com/iov-one/weave.Address" json:"trader,omitempty"`</span>
</code></pre>
<pre><code class="hljs css language-protobuf"><span class="hljs-built_in">bytes</span> order_book_id = <span class="hljs-number">3</span> [(gogoproto.customname) = <span class="hljs-string">"OrderBookID"</span>];
</code></pre>
<p><code>(gogoproto.customname)</code> indicates this field will be named as <code>OrderBookID</code>. Compiled codec.pb.go field:</p>
<pre><code class="hljs css language-go">OrderBookID []<span class="hljs-keyword">byte</span> <span class="hljs-string">`protobuf:"bytes,3,opt,name=order_book_id,json=orderBookId,proto3" json:"order_book_id,omitempty"`</span>
</code></pre>
<p>Without it we would get:</p>
<pre><code class="hljs css language-go">OrderBookId []<span class="hljs-keyword">byte</span> <span class="hljs-string">`protobuf:"bytes,3,opt,name=order_book_id,json=orderBookId,proto3" json:"order_book_id,omitempty"`</span>
</code></pre>
<p>As you can see above we define necessary fields that will be used by <code>handler</code> to interact with application state.</p>
<h2><a class="anchor" aria-hidden="true" id="compiling-proto-files"></a><a href="#compiling-proto-files" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compiling Proto Files</h2>
<p>To compile protobuf files, you need to have the <a href="https://github.com/google/protobuf#protocol-compiler-installation">protoc</a> binary installed and a language-specific translator (gogo-protobuf in this case). This can be a bit of a pain, especially the first time, so the default <strong>weave-starter-kit</strong> <a href="https://github.com/iov-one/weave-starter-kit/blob/master/Makefile">Makefile</a> contains helpers for you.</p>
<h3><a class="anchor" aria-hidden="true" id="prototool"></a><a href="#prototool" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prototool</h3>
<p>At IOV, we use <a href="https://github.com/iov-one/prototool-docker">prototool</a> for linting, formating and generating protobuf files. It is highly convenient and easy to use. Generating <code>*.pb.go</code> files are easy as running <code>make protoc</code> with Makefile script. Configuration is easier, just edit <code>prototool.yaml</code> or <code>prototool.json</code>.</p>
<p>Here is the <a href="https://github.com/iov-one/weave-starter-kit/blob/master/prototool.yaml">prototool.yaml</a> from <strong>weave-starter-kit</strong>:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">protoc:</span>
<span class="hljs-attr">  version:</span> <span class="hljs-number">3.7</span><span class="hljs-number">.1</span> <span class="hljs-comment"># Defines which version of protoc to use</span>

  <span class="hljs-comment"># If not set, compile will fail if there are unused imports.</span>
  <span class="hljs-comment"># Setting this will ignore unused imports.</span>
<span class="hljs-attr">  allow_unused_imports:</span> <span class="hljs-literal">false</span>

  <span class="hljs-comment"># Import parths</span>
<span class="hljs-attr">  includes:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">.</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">/usr/include</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">spec</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">spec/github.com/iov-one/weave</span>

<span class="hljs-comment"># excluded paths</span>
<span class="hljs-attr">excludes:</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">.git</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">spec</span>

<span class="hljs-attr">generate:</span>
<span class="hljs-attr">  go_options:</span>
<span class="hljs-attr">    import_path:</span> <span class="hljs-string">github.com/iov-one/weave-starter-kit</span>

<span class="hljs-attr">  plugins:</span>
<span class="hljs-attr">    - name:</span> <span class="hljs-string">gogofaster</span> <span class="hljs-comment"># Indicates gogofaster will be used.</span>
<span class="hljs-attr">      type:</span> <span class="hljs-string">gogo</span>
<span class="hljs-attr">      output:</span> <span class="hljs-string">.</span>

<span class="hljs-attr">lint:</span>
<span class="hljs-attr">  rules:</span>
<span class="hljs-attr">    remove:</span>
<span class="hljs-bullet">      -</span> <span class="hljs-string">FILE_OPTIONS_REQUIRE_JAVA_MULTIPLE_FILES</span>
<span class="hljs-bullet">      -</span> <span class="hljs-string">FILE_OPTIONS_REQUIRE_JAVA_OUTER_CLASSNAME</span>
<span class="hljs-bullet">      -</span> <span class="hljs-string">FILE_OPTIONS_REQUIRE_JAVA_PACKAGE</span>
<span class="hljs-bullet">      -</span> <span class="hljs-string">FILE_OPTIONS_REQUIRE_GO_PACKAGE</span>
</code></pre>
<ul>
<li><p><code>includes</code> field contains which import paths will be used when running protoc.</p>
<ul>
<li><code>.</code> means that <code>import &quot;x/custom/codec.go&quot;</code> will work inside this app (recommended to avoid GOPATH issues)</li>
<li><code>spec</code> means that we can <code>import &quot;github.com/iov-one/weave/coins/codec.proto&quot;</code> and it will use the protobuf file from our spec directory (which must be kept up to date with the weave repo).</li>
<li><code>spec/github.com/iov-one/weave</code> is needed as if we import eg. <code>github.com/iov-one/weave/x/cash/codec.proto</code>, it imports <code>coins/codec.proto</code> using relative imports to it's project. When we then import this via spec, the relative import doesn't work without this second line.</li>
</ul></li>
<li><p><code>excludes</code> field contains which paths to exclude when compiling protobuf. <code>spec</code> directory contains the weave codecs that will be used in modules, so no need to compile these.</p></li>
</ul>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">generate:</span>
<span class="hljs-attr">  go_options:</span>
<span class="hljs-attr">    import_path:</span> <span class="hljs-string">github.com/iov-one/weave-starter-kit</span>
</code></pre>
<ul>
<li>The base import path. This should be the go path of the prototool.yaml file. This is required if you have any go plugins.</li>
</ul>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">plugins:</span>
<span class="hljs-attr">    - name:</span> <span class="hljs-string">gogofaster</span> <span class="hljs-comment"># Indicates gogofaster will be used.</span>
<span class="hljs-attr">      type:</span> <span class="hljs-string">gogo</span>
<span class="hljs-attr">      output:</span> <span class="hljs-string">.</span>
</code></pre>
<ul>
<li><p>This part tells protool to use <code>gogofaster</code> plugin and output is current directory.
You are welcome to use other codecs than <code>gogofaster</code>, you can also try the standard Go language protobuf compiler. What this mode goes is auto-generate static code for serialization and deserialization of the type. It performs the introspection one time to generate efficient code allowing us to avoid the use of reflection at runtime and get ~10x speed ups in the serialization/deserialization. I like this, but this may vary based on your preference or aversion of auto-generated code.</p></li>
<li><p><code>lint</code> field defines the linting rules. Extra rules could be added if desired.</p></li>
</ul>
<p>After defining your state and messages run <code>make protoc</code>. This script will download <code>prototool</code> docker image and compile codec.proto file <code>codec.pb.go</code> file.
Now we have scaffold of our application thanks to auto-generated <em>codec.pb.go</em> file.</p>
<h2><a class="anchor" aria-hidden="true" id="using-autogenerated-structs"></a><a href="#using-autogenerated-structs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using Autogenerated Structs</h2>
<p>The first time through the above process may appear tedious, but once you get the hang of it, you just have to add a few lines to a <em>.proto</em> file and type <code>make protoc</code>. Et voila! You have a bunch of fresh *.pb.go files that provide efficient, portable serialization for your code.</p>
<p>But how do you use those structs? Taking <code>Amount</code> from <a href="https://orkunkl.github.com/iov-one/tutorial/blob/master/x/orderbook/codec.proto#L10-L23">x/codec.proto</a> as an example, we see a <code>x/codec.pb.go</code> file with <code>type Amount struct {...}</code> that closely mirrors the content of the codec.proto file, as well as many of methods. There are some auto-generated getters, which can be useful to fulfill interfaces or to query field of <em>nil</em> objects without panicking. And then there are some (very long) <strong>Marshal</strong> and <strong>Unmarshal</strong> methods. These are the meat of the matter. They fulfill the Persistent interface and let us write code like this:</p>
<pre><code class="hljs css language-go">orig := Amount{Whole: <span class="hljs-number">123</span>, franctional: <span class="hljs-number">2</span>}
bz, err := orig.Marshal()
parsed := Amount{}
err = parsed.Unmarshal(bz)
</code></pre>
<p>This is fine, but what happens when I want to add custom logic to my Amount struct, perhaps adding validation logic, or code to add two coins? Luckily for us, go allows you two write methods for your structs in any file in the same package. That means that we can just inherit the struct definition and all the serialization logic and just append the methods we care about. <a href="https://github.com/iov-one/tutorial/blob/master/x/orderbook/amount.go">x/amount.go</a> is a great example of extending the functionality, with code like:</p>
<pre><code class="hljs css language-go"><span class="hljs-comment">// IsPositive returns true if the value is greater than 0</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Amount)</span> <span class="hljs-title">IsPositive</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> {
    <span class="hljs-keyword">return</span> a.Whole &gt; <span class="hljs-number">0</span> ||
        (a.Whole == <span class="hljs-number">0</span> &amp;&amp; a.Fractional &gt; <span class="hljs-number">0</span>)
}

<span class="hljs-comment">// IsNegative returns true if the value is less than 0</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Amount)</span> <span class="hljs-title">IsNegative</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> {
    <span class="hljs-keyword">return</span> a.Whole &lt; <span class="hljs-number">0</span> ||
        (a.Whole == <span class="hljs-number">0</span> &amp;&amp; a.Fractional &lt; <span class="hljs-number">0</span>)
}
</code></pre>
<p>This is a productive workflow and I recommend trying it out. You may find it doesn’t work for you and you can try other approaches, like copying the protobuf generated structs into some custom-written structs you like and then copying back into protobuf structs for serialization. You can also try playing with special <a href="https://github.com/gogo/protobuf/blob/master/extensions.md">protobuf extensions</a> flags in your protobuf files to shape the auto-generated code into the exact shape you want.</p>
<h2><a class="anchor" aria-hidden="true" id="notes-about-oneof"></a><a href="#notes-about-oneof" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Notes About oneof</h2>
<p><strong>oneof</strong> is a powerful feature to produce union/sum types in your protobuf structures. For example, you may have a public key which may be one of many different algorithms and can define cases for each, which can be switched upon in runtime. We also use this for the transaction to enumerate a set of possible messages that can be embedded in the transaction. A transaction may have any one of them and serialize and deserialize properly. Type-safety is enforced in compile-time and we can switch on the kind on runtime. (Example from <a href="https://github.com/iov-one/bcp-demo/blob/master/app/codec.proto">bcp-demo</a>):</p>
<pre><code class="hljs css language-protobuf"><span class="hljs-keyword">oneof</span> sum {
  cash.SendMsg send_msg = <span class="hljs-number">1</span>;
  namecoin.CreateTokenMsg new_token_msg = <span class="hljs-number">2</span>;
  namecoin.SetWalletNameMsg set_name_msg = <span class="hljs-number">3</span>;
  escrow.CreateMsg create_escrow_msg = <span class="hljs-number">4</span>;
  escrow.ReleaseMsg release_escrow_msg = <span class="hljs-number">5</span>;
  escrow.ReturnMsg return_escrow_msg = <span class="hljs-number">6</span>;
  escrow.UpdatePartiesMsg update_escrow_msg = <span class="hljs-number">7</span>;
}
</code></pre>
<p>The only problem is that the generated code is ugly to some people’s eyes. This lies in the fact that there is no clean way to express sum types in Go, and you have to force an interface with private methods to close the set of possible types. Although some people have been so revolted by this code that they preferred to <a href="https://github.com/tendermint/go-amino" title="go-amino">write their own serialization library</a>, I would suggest just taking the breath and getting to know it. Here are the relevant pieces:</p>
<pre><code class="hljs css language-go"><span class="hljs-keyword">type</span> Tx <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// msg is a sum type over all allowed messages on this chain.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Types that are valid to be assigned to Sum:</span>
    <span class="hljs-comment">//  *Tx_SendMsg</span>
    <span class="hljs-comment">//  *Tx_CreateTokenMsg</span>
    <span class="hljs-comment">//  *Tx_SetNameMsg</span>
    <span class="hljs-comment">//  *Tx_CreateMsg</span>
    <span class="hljs-comment">//  *Tx_ReleaseMsg</span>
    <span class="hljs-comment">//  *Tx_ReturnMsg</span>
    <span class="hljs-comment">//  *Tx_UpdateEscrowMsg</span>
    Sum isTx_Sum <span class="hljs-string">`protobuf_oneof:"sum"`</span>
...
}

<span class="hljs-keyword">type</span> isTx_Sum <span class="hljs-keyword">interface</span> {
    isTx_Sum()
    MarshalTo([]<span class="hljs-keyword">byte</span>) (<span class="hljs-keyword">int</span>, error)
    Size() <span class="hljs-keyword">int</span>
}

<span class="hljs-keyword">type</span> Tx_SendMsg <span class="hljs-keyword">struct</span> {
    SendMsg *cash.SendMsg <span class="hljs-string">`protobuf:"bytes,1,opt,name=send_msg,json=sendMsg,oneof"`</span>
}
<span class="hljs-keyword">type</span> Tx_CreateTokenMsg <span class="hljs-keyword">struct</span> {
    CreateTokenMsg *namecoin.CreateTokenMsg <span class="hljs-string">`protobuf:"bytes,2,opt,name=new_token_msg,json=newTokenMsg,oneof"`</span>
}
</code></pre>
<p>We now have some intermediate structs that give us a layer of indirection in order to enforce the fact we can now securely switch over all possible <code>tx.Sum</code> fields, with <a href="https://github.com/iov-one/bcp-demo/blob/master/app/tx.go#L33-61">code like this</a>:</p>
<pre><code class="hljs css language-go">sum := tx.GetSum()
<span class="hljs-keyword">switch</span> t := sum.(<span class="hljs-keyword">type</span>) {
<span class="hljs-keyword">case</span> *Tx_SendMsg:
    <span class="hljs-keyword">return</span> t.SendMsg, <span class="hljs-literal">nil</span>
<span class="hljs-keyword">case</span> *Tx_SetNameMsg:
    <span class="hljs-keyword">return</span> t.SetNameMsg, <span class="hljs-literal">nil</span>
<span class="hljs-keyword">case</span> *Tx_CreateTokenMsg:
    <span class="hljs-keyword">return</span> t.CreateTokenMsg, <span class="hljs-literal">nil</span>
<span class="hljs-keyword">case</span> *Tx_CreateMsg:
    <span class="hljs-keyword">return</span> t.CreateMsg, <span class="hljs-literal">nil</span>
<span class="hljs-keyword">case</span> *Tx_ReleaseMsg:
    <span class="hljs-keyword">return</span> t.ReleaseMsg, <span class="hljs-literal">nil</span>
<span class="hljs-keyword">case</span> *Tx_ReturnMsg:
    <span class="hljs-keyword">return</span> t.ReturnMsg, <span class="hljs-literal">nil</span>
<span class="hljs-keyword">case</span> *Tx_UpdateEscrowMsg:
    <span class="hljs-keyword">return</span> t.UpdateEscrowMsg, <span class="hljs-literal">nil</span>
}
</code></pre>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 2019-8-13 by Orkun Külçe</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/weave-tutorial/domain"><span class="arrow-prev">← </span><span>Domain</span></a><a class="docs-next button" href="/docs/weave-tutorial/models"><span>Models</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#create-codec-file">Create Codec file</a></li><li><a href="#state">State</a></li><li><a href="#message-definitions">Message Definitions</a></li><li><a href="#compiling-proto-files">Compiling Proto Files</a><ul class="toc-headings"><li><a href="#prototool">Prototool</a></li></ul></li><li><a href="#using-autogenerated-structs">Using Autogenerated Structs</a></li><li><a href="#notes-about-oneof">Notes About oneof</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>Docs</h5><a href="/docs/iov-name-service/validator/rewards">IOV Name Service</a><a href="/docs/weave/welcome">Weave</a></div><div><h5>Community</h5><a href="https://riot.im/app/#/room/#weave:matrix.org" target="_blank">Riot Chat</a><a href="https://t.me/internetofvalues" target="_blank">Telegram</a><a href="https://twitter.com/iov_official" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="https://github.com/iov-one" target="_blank">GitHub</a><a href="https://www.iov.one" target="_blank">Website</a></div></section><section class="copyright">Copyright © 2019 IOV</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '8dc8128a9091306e7bbd0effdaa5241a',
                indexName: 'iov',
                inputSelector: '#search_input_react'
              });
            </script></body></html>